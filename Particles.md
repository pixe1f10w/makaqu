# Introduction #

The completely inconsistent behavior of the previous particle renderers (both the rounded and the square ones) was something that always bugged me.

Besides having no more fixed size limitations, now the particles also obeys the video aspect.

Now the particles are rendered as primitives, but there’s a lot of room for optimization and I’m quite sure I can get this code really fast, either faster than the previous renderer or very close to it.

I also found that the previous round particle renderer checked the particle’s depth from the center pixel of the top line, instead of from the center pixel of the center line. I’ve just fixed this, and now I’ve got to make the video edge detection behave consistently across all different video aspects. I’ve also got to check the particles’ positions, because it seems that they’re being aligned to the right of the camera instead of to its center, and the final touch will be to make the code recalculate the particles’ radius to make sure that the amount of screen area covered by each round particle is the same that would be covered if they were square.

I’m thinking about not implementing the square-to-round area compensation. The reason for this is because the square particle renderer always truncated the particles’ sizes after a certain limit, and since the new round particle renderer doesn’t have this limit, the biggest particles from it are bigger than the ones from the square renderer anyway.

By the way, having full-range-scaled particles is nice. It gives a much better sense of depth, specially on explosions and on projectiles’ trails. Making a snooker game or something similar would be quite easy now.

Now the particle drawing algorithm can both scale the particle from a single pixel to the whole screen, and stretch its dimensions to any video aspect perfectly.

The last wrong thing I’ve noticed in the particle renderer is that the scale of the particles isn’t consistent across different screen resolutions.

another interesting side effect of the optimization: Since all particles have the same proportional size in 3D space, sorting particles by size also sorts them by depth (although less accurately than a Z-sorting algorithm would do), which in turn allows a greater number of smaller particles to be rendered, since their Z-checks won’t collide against the bigger particles anymore. So, more particles, depth-sorted, and faster to draw; definitely a good outcome.

The particles needed to be centered not only on the X and Y axes of the screen, but also on the Z axis. It’s amazing how something like this should have been obvious yet I haven’t thought of it before.
Update: Actually, they don’t need to be centered, because since they don’t have any radius their origin position is actually at their center.

What’s actually happening is that the slight misalignment I’m seeing on them is caused by the lack of 3D perspective on the filled ellipses generated by my algorithm. There’s simply no way to add 3D perspective to the drawing code while also keeping it as fast as it is, so I’ll keep it in 2D.

In my opinion, Quake’s particle renderer was designed to have as little impact on the rendering performance as possible, and I don’t want to change this.


# Details #

Add your content here.  Format your content with:
  * Text in **bold** or _italic_
  * Headings, paragraphs, and lists
  * Particle lighting is in. It can be turned off, and I’ve also implemented a console variable to disable fullbrights on the color shading map of particles.
  * The minimum level of light for them is the same as for the viewmodel, which is just enough to distinguish their color in the dark. If I ever see a good reason to allow particles to go fully black, I may make this optional.